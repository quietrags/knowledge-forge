<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knowledge Forge v3</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Source+Serif+4:wght@300;400;500;600&family=Source+Sans+3:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #059669;
      --accent-bg: #ECFDF5;
      --bg-primary: #FAFAF9;
      --bg-secondary: #fff;
      --bg-tertiary: #F5F5F4;
      --text-primary: #1C1917;
      --text-secondary: #57534E;
      --text-muted: #A8A29E;
      --border: #E7E5E4;
      --insight: #059669;
      --doubt: #D97706;
      --gap: #DC2626;
      --idea: #7C3AED;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Source Sans 3', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 15px;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ======================== HEADER ======================== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .logo {
      font-family: 'Cormorant Garamond', serif;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .mode-switch {
      display: flex;
      gap: 2px;
      background: var(--bg-tertiary);
      padding: 4px;
      border-radius: 8px;
    }
    .mode-btn {
      padding: 8px 20px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
    }
    .mode-btn:hover { color: var(--text-secondary); }
    .mode-btn.active {
      background: var(--bg-secondary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      font-weight: 600;
    }
    .mode-btn.active[data-mode="build"] { color: #059669; }
    .mode-btn.active[data-mode="understand"] { color: #2563EB; }
    .mode-btn.active[data-mode="research"] { color: #7C3AED; }

    /* ======================== PATH BAR ======================== */
    .path-bar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 10px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }
    .path-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }
    .path-trail { display: flex; align-items: center; gap: 6px; flex: 1; }
    .path-node {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .path-node:hover { background: var(--bg-tertiary); }
    .path-node.current { background: var(--accent-bg); font-weight: 600; color: var(--accent); }
    .node-dot { width: 8px; height: 8px; border-radius: 50%; }
    .node-dot.solid { background: var(--accent); }
    .node-dot.partial { background: linear-gradient(90deg, var(--accent) 50%, var(--border) 50%); }
    .path-arrow { color: #D4D4D4; font-size: 11px; }
    .path-divider { width: 1px; height: 20px; background: var(--border); margin: 0 8px; }
    .neighbors-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .neighbor-chips { display: flex; gap: 6px; }
    .neighbor-chip {
      font-size: 12px;
      padding: 4px 10px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .neighbor-chip:hover { background: var(--border); }

    /* ======================== MAIN LAYOUT ======================== */
    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 420px;
      grid-template-rows: 1fr 1fr;
      overflow: hidden;
      gap: 1px;
      background: var(--border);
    }

    /* ======================== KNOWLEDGE AREA ======================== */
    .knowledge-area {
      grid-row: 1 / -1;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .content-tabs {
      display: flex;
      gap: 0;
      background: var(--bg-tertiary);
      padding: 8px 24px 0;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .content-tab {
      padding: 10px 18px;
      background: transparent;
      border: none;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      color: var(--text-muted);
      transition: all 0.15s;
      position: relative;
    }
    .content-tab:hover { color: var(--text-primary); }
    .content-tab.active {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 500;
    }
    .content-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }
    .content-body {
      flex: 1;
      overflow-y: auto;
      padding: 32px 40px;
      max-width: 800px;
    }
    .content-panel { display: none; }
    .content-panel.active { display: block; }

    /* ======================== NARRATIVE STYLES ======================== */
    .narrative-header { margin-bottom: 28px; }
    .narrative-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }
    .narrative-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 32px;
      font-weight: 600;
      line-height: 1.2;
      letter-spacing: -0.02em;
    }
    .narrative-meta {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .prose {
      font-family: 'Source Serif 4', Georgia, serif;
      font-size: 17px;
      line-height: 1.8;
      color: var(--text-primary);
    }
    .prose p { margin-bottom: 1.25em; }
    .prose h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 24px;
      font-weight: 600;
      margin: 2em 0 0.75em 0;
    }
    .prose h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 1.5em 0 0.5em 0;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .prose strong { color: var(--accent); font-weight: 600; }
    .prose ul, .prose ol { margin: 1em 0 1.25em 1.5em; }
    .prose li { margin-bottom: 0.5em; }

    .callout {
      padding: 16px 20px;
      border-radius: 8px;
      margin: 1.5em 0;
      font-family: 'Source Sans 3', sans-serif;
      font-size: 15px;
      line-height: 1.6;
    }
    .callout.insight {
      background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
      border-left: 4px solid var(--insight);
    }
    .callout.insight::before {
      content: 'üí° Insight';
      display: block;
      font-weight: 600;
      color: var(--insight);
      margin-bottom: 6px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .callout.gap {
      background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
      border-left: 4px solid var(--doubt);
    }
    .callout.gap::before {
      content: '‚ö†Ô∏è Gap';
      display: block;
      font-weight: 600;
      color: var(--doubt);
      margin-bottom: 6px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .callout.prior {
      background: var(--bg-tertiary);
      border-left: 4px solid var(--text-muted);
    }
    .callout.prior::before {
      content: 'üìö Prior';
      display: block;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ======================== Q&A / CONCEPTS / QUESTIONS ======================== */
    .qa-list { display: flex; flex-direction: column; gap: 16px; }
    .qa-item { background: var(--bg-tertiary); border-radius: 8px; overflow: hidden; }
    .qa-question {
      padding: 14px 18px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .qa-question::before {
      content: 'Q';
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      background: var(--accent);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 700;
      flex-shrink: 0;
    }
    .qa-answer {
      padding: 0 18px 14px 50px;
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .concept-grid { display: flex; flex-direction: column; gap: 12px; }
    .concept-item {
      padding: 16px 20px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
    }
    .concept-term { font-weight: 600; font-size: 16px; margin-bottom: 6px; }
    .concept-def { font-size: 14px; line-height: 1.6; color: var(--text-secondary); }

    .question-list { display: flex; flex-direction: column; gap: 10px; }
    .question-item {
      padding: 14px 18px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .question-item:hover {
      background: var(--accent-bg);
      border-left: 3px solid var(--accent);
      padding-left: 15px;
    }
    .question-item::before {
      content: '?';
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 700;
      flex-shrink: 0;
    }

    /* ======================== RESEARCH: QUESTION TREE ======================== */
    .question-tree { display: flex; flex-direction: column; gap: 16px; }

    .research-question {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .research-question.answered { border-left: 4px solid var(--insight); }
    .research-question.researching { border-left: 4px solid var(--idea); }
    .research-question.pending { border-left: 4px solid var(--text-muted); }

    .rq-header {
      padding: 16px 20px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
    }
    .rq-status {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }
    .rq-status.answered { background: var(--accent-bg); color: var(--insight); }
    .rq-status.researching { background: #F3E8FF; color: var(--idea); }
    .rq-status.pending { background: var(--bg-tertiary); color: var(--text-muted); }
    .rq-content { flex: 1; }
    .rq-question { font-weight: 600; font-size: 16px; line-height: 1.4; }
    .rq-meta { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    .rq-body {
      padding: 0 20px 20px 56px;
      display: none;
    }
    .research-question.expanded .rq-body { display: block; }

    .rq-answer {
      background: var(--accent-bg);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      line-height: 1.7;
    }
    .rq-answer-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--insight);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .rq-sources {
      margin-bottom: 16px;
    }
    .rq-sources-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    .rq-source {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 6px;
    }
    .rq-source a { color: var(--text-primary); text-decoration: none; }
    .rq-source a:hover { text-decoration: underline; }
    .rq-source-cred {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .rq-source-cred.primary { background: #ECFDF5; color: #059669; }
    .rq-source-cred.high { background: #EFF6FF; color: #2563EB; }

    .rq-emergent {
      background: linear-gradient(135deg, #FEF2F2 0%, #FECACA 100%);
      padding: 12px 16px;
      border-radius: 8px;
      border-left: 3px solid var(--gap);
    }
    .rq-emergent-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--gap);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }
    .rq-emergent-item {
      font-size: 13px;
      color: var(--text-secondary);
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .rq-emergent-item::before { content: '‚Üí'; color: var(--gap); }

    /* Add question button */
    .add-question-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      background: var(--bg-tertiary);
      border: 2px dashed var(--border);
      border-radius: 10px;
      font-size: 14px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    .add-question-btn:hover {
      background: var(--accent-bg);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ======================== RIGHT PANELS ======================== */
    .panel {
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .panel-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }
    .panel-actions { display: flex; gap: 6px; }
    .panel-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .panel-btn:hover { background: var(--bg-tertiary); }
    .panel-body { flex: 1; overflow-y: auto; padding: 16px 18px; }

    /* ======================== CODE PANEL ======================== */
    .code-file {
      font-size: 12px;
      color: #A8A29E;
      margin-bottom: 10px;
      font-family: 'IBM Plex Mono', monospace;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      background: #292524;
      border-radius: 8px 8px 0 0;
    }
    .code-block {
      background: #1C1917;
      color: #E7E5E4;
      padding: 20px;
      border-radius: 0 0 8px 8px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px;
      line-height: 1.8;
      overflow-x: auto;
    }
    .code-block .kw { color: #C4B5FD; font-weight: 500; }
    .code-block .fn { color: #93C5FD; }
    .code-block .str { color: #86EFAC; }
    .code-block .cmt { color: #78716C; font-style: italic; }
    .code-block .num { color: #FCD34D; }
    .code-block .op { color: #FDA4AF; }
    .code-block .type { color: #67E8F9; }

    .library-ref {
      margin-top: 12px;
      padding: 12px 14px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 13px;
    }
    .library-ref-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }
    .library-ref a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }
    .library-ref a:hover { text-decoration: underline; }

    /* ======================== CANVAS PANEL ======================== */
    .canvas-tabs { display: flex; gap: 4px; margin-bottom: 14px; }
    .canvas-tab {
      padding: 7px 14px;
      font-size: 12px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .canvas-tab:hover { background: var(--bg-tertiary); }
    .canvas-tab.active { background: var(--text-primary); color: white; border-color: var(--text-primary); }
    .canvas-content {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 18px;
      display: none;
    }
    .canvas-content.active { display: block; }
    .canvas-content h4 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 18px;
      margin-bottom: 12px;
    }
    .canvas-content p { line-height: 1.6; color: var(--text-secondary); margin-bottom: 10px; font-size: 14px; }
    .canvas-content ul { margin-left: 18px; line-height: 1.8; color: var(--text-secondary); font-size: 14px; }

    /* ======================== CHAT ======================== */
    .chat {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 14px 24px;
      flex-shrink: 0;
    }
    .chat-inner { display: flex; gap: 12px; align-items: center; }
    .chat-input {
      flex: 1;
      padding: 14px 18px;
      background: var(--bg-tertiary);
      border: 1px solid transparent;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.15s;
    }
    .chat-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-secondary);
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }
    .chat-hint { font-size: 13px; color: var(--text-muted); }

    /* Research progress indicator */
    .research-progress {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
    }
    .progress-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .progress-stat .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .progress-stat .dot.answered { background: var(--insight); }
    .progress-stat .dot.researching { background: var(--idea); }
    .progress-stat .dot.pending { background: var(--text-muted); }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">Knowledge Forge</div>
    <div class="mode-switch">
      <button class="mode-btn active" data-mode="build" onclick="setMode('build')">build</button>
      <button class="mode-btn" data-mode="understand" onclick="setMode('understand')">understand</button>
      <button class="mode-btn" data-mode="research" onclick="setMode('research')">research</button>
    </div>
  </header>

  <div class="path-bar" id="path-bar"></div>

  <main class="main">
    <div class="knowledge-area">
      <div class="content-tabs" id="content-tabs"></div>
      <div class="content-body" id="content-body"></div>
    </div>
    <div class="panel" id="code-panel"></div>
    <div class="panel" id="canvas-panel"></div>
  </main>

  <div class="chat">
    <div class="chat-inner">
      <input type="text" class="chat-input" id="chat-input" placeholder="Ask a question or add to research...">
      <span class="chat-hint">‚Üµ send</span>
    </div>
  </div>

  <script>
    const modeData = {
      build: {
        accent: '#059669',
        accentBg: '#ECFDF5',
        path: {
          nodes: [
            { name: 'ML Basics', status: 'solid' },
            { name: 'Computer Vision', status: 'solid' },
            { name: 'Doc Intelligence', status: 'partial' }
          ],
          neighbors: ['RAG Pipelines', 'VLM Fine-tuning', 'OCR Evaluation']
        },
        tabs: ['Knowledge Narrative', 'Boundaries', 'Concepts', 'Questions I Can Answer'],
        panels: {
          narrative: {
            label: 'Building',
            title: 'Document Intelligence Models',
            meta: 'Session 2 ‚Ä¢ Building on: tesseract_ocr, http_endpoints, ml_model_workflow',
            content: `
              <div class="callout prior">
                You already know how to call HTTP endpoints and handle responses. You've used Tesseract OCR and experienced its limitation: <strong>flat text with no structure</strong>. You understand ML model loading patterns from sklearn and Keras.
              </div>

              <h2>Why Document Intelligence Models Exist</h2>
              <p>Traditional OCR like Tesseract reads pixels left-to-right, top-to-bottom. It treats documents as a continuous stream of text. But documents have <strong>structure</strong>: headings, paragraphs, tables, columns, images with captions.</p>
              <p>When you fed a two-column document to Tesseract, the output was garbled. The text from column one mixed with column two because the OCR didn't understand columns‚Äîit just read left to right across the page.</p>

              <div class="callout insight">
                Modern document intelligence models solve this with a <strong>layout-first approach</strong>: they detect document regions, classify element types, determine reading order, and <em>then</em> extract text. The output isn't just text‚Äîit's structured regions with types, bounding boxes, and reading order.
              </div>

              <h2>Output Formats and Their Uses</h2>
              <p>You initially guessed JSON would be best for LLM consumption. But consider: LLMs are trained on natural language, and Markdown is closer to natural language than JSON. The format choice depends on <strong>what consumes the output</strong>, not the OCR step.</p>
              <ul>
                <li><strong>Markdown</strong> ‚Üí LLM consumption (RAG, Q&A, summarization)</li>
                <li><strong>JSON</strong> ‚Üí Programmatic extraction (invoice processing, form filling)</li>
                <li><strong>HTML</strong> ‚Üí Digital reconstruction (archiving, web display)</li>
                <li><strong>DocTags</strong> ‚Üí When precise coordinates matter</li>
              </ul>

              <div class="callout gap">
                You asked about handwritten text. Most models struggle here. Nanonets-OCR2 specifically targets handwriting, signatures, and watermarks‚Äîbut even it isn't perfect. For critical handwriting extraction, human validation may still be necessary.
              </div>

              <h2>The Model Landscape</h2>
              <p>A key realization: these aren't fixed-output OCR engines. They're <strong>promptable Vision-Language Models</strong>. The same model can output Markdown, JSON, or answer questions‚Äîcontrolled by your prompt.</p>
            `
          },
          boundaries: [
            { q: 'How does layout detection differ from simple OCR preprocessing?', a: 'Preprocessing (deskewing, denoising) improves input quality but doesn\'t understand structure. Layout detection identifies semantic regions (heading vs paragraph vs table) and their relationships.' },
            { q: 'When would I use DocTags format over Markdown?', a: 'When you need precise bounding box coordinates‚Äîfor example, building a document editor that lets users click on extracted regions.' },
            { q: 'Can these models handle documents with mixed languages?', a: 'Models like DeepSeek-OCR and PaddleOCR-VL support 100+ languages and can handle mixed-language documents.' }
          ],
          concepts: [
            { term: 'Layout Detection', def: 'Identifying regions in a document before extracting text. Outputs bounding boxes and region types.' },
            { term: 'Reading Order', def: 'The semantic sequence for reading document regions. A two-column document reads down column one, then down column two.' },
            { term: 'Vision-Language Model (VLM)', def: 'A model that processes both images and text, enabling visual understanding with natural language output.' }
          ],
          questions: [
            'Why does layout detection need to happen before text extraction?',
            'What output format would you choose for a RAG pipeline, and why?',
            'How would you decide between DeepSeek-OCR and Nanonets-OCR2 for invoice processing?'
          ]
        },
        code: {
          file: 'doc_pipeline.py',
          content: `<span class="cmt"># Document Intelligence Pipeline</span>

<span class="kw">import</span> base64
<span class="kw">from</span> openai <span class="kw">import</span> OpenAI

<span class="kw">def</span> <span class="fn">doc_to_markdown</span>(image_path: <span class="type">str</span>) <span class="op">-></span> <span class="type">str</span>:
    <span class="str">"""Convert document image to structured markdown."""</span>
    <span class="kw">with</span> open(image_path, <span class="str">"rb"</span>) <span class="kw">as</span> f:
        image_data <span class="op">=</span> base64.b64encode(f.read()).decode()

    client <span class="op">=</span> OpenAI(base_url<span class="op">=</span><span class="str">"http://localhost:8000/v1"</span>)

    response <span class="op">=</span> client.chat.completions.create(
        model<span class="op">=</span><span class="str">"deepseek-ocr"</span>,
        messages<span class="op">=</span>[{
            <span class="str">"role"</span>: <span class="str">"user"</span>,
            <span class="str">"content"</span>: [
                {<span class="str">"type"</span>: <span class="str">"image_url"</span>,
                 <span class="str">"image_url"</span>: {<span class="str">"url"</span>: <span class="str">f"data:image/png;base64,{image_data}"</span>}},
                {<span class="str">"type"</span>: <span class="str">"text"</span>,
                 <span class="str">"text"</span>: <span class="str">"Convert to markdown. Preserve structure."</span>}
            ]
        }]
    )
    <span class="kw">return</span> response.choices[<span class="num">0</span>].message.content`,
          library: { name: 'DeepSeek-OCR', url: 'https://huggingface.co/deepseek-ai/DeepSeek-OCR', desc: 'Open-source VLM for document intelligence' }
        },
        canvas: {
          summary: { title: 'Document Intelligence Pipeline', content: '<p><strong>Image ‚Üí Layout Detection ‚Üí Element Classification ‚Üí Reading Order ‚Üí Structured Output</strong></p><p>Format choice depends on downstream use: Markdown for LLMs, JSON for programmatic access.</p>' },
          diagram: '<div style="text-align:center; padding: 20px; background: white; border-radius: 6px;"><pre style="font-family: monospace; font-size: 12px; line-height: 2;">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ   Document  ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n       ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ   Layout    ‚îÇ\n‚îÇ  Detection  ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n       ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ  Structured ‚îÇ\n‚îÇ   Output    ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</pre></div>'
        }
      },

      understand: {
        accent: '#2563EB',
        accentBg: '#EFF6FF',
        path: {
          nodes: [
            { name: 'LLM Basics', status: 'solid' },
            { name: 'Prompting', status: 'solid' },
            { name: 'Agent Architectures', status: 'partial' }
          ],
          neighbors: ['Tool Use', 'Memory Systems', 'Multi-Agent']
        },
        tabs: ['Knowledge Essay', 'Misconceptions', 'Insights', 'Mental Model'],
        panels: {
          narrative: {
            label: 'Understanding',
            title: 'Agent Architectures',
            meta: 'Addressing: failure modes, architecture selection, complexity tradeoffs',
            content: `
              <div class="callout prior">
                You understand the basic ReACT loop: think, act, observe, repeat. You know Reflexion adds self-critique. You understand planning as upfront structure. What's less clear: when does each pattern fail, and how do you choose?
              </div>

              <h2>ReACT: Power and Limits</h2>
              <p>ReACT works like print debugging for AI. The explicit "thought" step makes reasoning visible‚Äîyou can see <em>why</em> the agent chose an action.</p>
              <p>But ReACT is <strong>greedy</strong>. It makes locally optimal decisions without lookahead. This creates failure modes:</p>
              <ul>
                <li><strong>No natural stopping point</strong> ‚Äî doesn't know when "good enough" is achieved</li>
                <li><strong>Context overflow</strong> ‚Äî Long chains exhaust the context window</li>
                <li><strong>Tool fixation</strong> ‚Äî Getting stuck retrying a failing tool</li>
              </ul>

              <div class="callout insight">
                <strong>"ReACT needs external termination logic because it has no internal sense of 'done'"</strong> ‚Äî The solution isn't architectural, it's operational: max iterations, token budgets, explicit "done" tools.
              </div>

              <h2>When Structure Matters: Planning</h2>
              <p>If your agent's outputs are incoherent across steps‚Äîthat's a <strong>structure problem</strong>. Plan-and-Execute creates upfront structure.</p>

              <div class="callout gap">
                <strong>When should an agent replan?</strong> For high-stakes, irreversible actions‚Äîlock the plan and escalate on failure rather than creatively adapting.
              </div>
            `
          },
          misconceptions: [
            { q: 'When ReACT fails, should I switch architectures?', a: 'Usually no. Most failures are configuration issues: bad prompts, poor tool descriptions, missing guardrails. Analyze the failure trace first.' },
            { q: 'Doesn\'t adding planning and reflection always improve outcomes?', a: 'No‚Äîcomplexity is cost. Each layer adds latency, token usage, and debugging surface. Start simple, add complexity only when proven needed.' }
          ],
          insights: [
            { insight: '"The Thought in ReACT isn\'t just logging‚Äîit\'s active cognition that improves the subsequent action"', context: 'Remove the thought step and action quality degrades.' },
            { insight: '"You can stack architectures: Plan + Reflexion for tasks with both sequence AND quality needs"', context: 'They\'re not mutually exclusive‚Äîcombine based on the specific problem.' },
            { insight: '"For code, tests are the gold standard external signal‚Äînot LLM self-judgment"', context: 'When external validation exists, use it.' }
          ],
          mentalModel: `
            <h2>Architecture Selection Framework</h2>
            <div class="callout insight">
              <strong>Match problem type to solution:</strong>
            </div>
            <ul>
              <li><strong>Structure problems</strong> ‚Üí Add Planning</li>
              <li><strong>Quality problems</strong> ‚Üí Add Reflexion</li>
              <li><strong>Speed/cost problems</strong> ‚Üí Simplify to ReACT</li>
              <li><strong>No stopping</strong> ‚Üí Add guardrails</li>
            </ul>
          `
        },
        code: {
          file: 'agent_patterns.py',
          content: `<span class="cmt"># Agent Architecture Patterns</span>

<span class="kw">def</span> <span class="fn">react_loop</span>(
    agent,
    task: <span class="type">str</span>,
    max_iterations: <span class="type">int</span> <span class="op">=</span> <span class="num">10</span>
):
    <span class="str">"""ReACT with external termination."""</span>
    <span class="kw">for</span> i <span class="kw">in</span> range(max_iterations):
        thought <span class="op">=</span> agent.think(task)
        action <span class="op">=</span> agent.decide(thought)

        <span class="kw">if</span> action.type <span class="op">==</span> <span class="str">"done"</span>:
            <span class="kw">return</span> action.result

        observation <span class="op">=</span> agent.execute(action)
        task <span class="op">=</span> agent.update_context(observation)

    <span class="kw">raise</span> TimeoutError(<span class="str">"Max iterations"</span>)`,
          library: { name: 'Claude Agent SDK', url: 'https://docs.anthropic.com/en/docs/agents-and-tools', desc: 'Official SDK for building AI agents' }
        },
        canvas: {
          summary: { title: 'Decision Tree', content: '<ul><li>Structure problems ‚Üí Planning</li><li>Quality problems ‚Üí Reflexion</li><li>Speed/cost ‚Üí Simplify</li></ul>' },
          diagram: '<div style="text-align:center; padding: 20px; background: white; border-radius: 6px;"><pre style="font-family: monospace; font-size: 11px;">Problem Analysis\n       ‚îÇ\n       ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Structure?   ‚îÇ‚îÄYes‚îÄ‚ñ∂ Planning\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n       ‚îÇ No\n       ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Quality?     ‚îÇ‚îÄYes‚îÄ‚ñ∂ Reflexion\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n       ‚îÇ No\n       ‚ñº\n    ReACT</pre></div>'
        }
      },

      research: {
        accent: '#7C3AED',
        accentBg: '#F3E8FF',
        path: {
          nodes: [
            { name: 'AI Development', status: 'solid' },
            { name: 'Coding Tools', status: 'solid' },
            { name: 'Agent Economics', status: 'partial' }
          ],
          neighbors: ['Token Optimization', 'Enterprise Adoption', 'ROI Models']
        },
        tabs: ['Question Tree', 'All Findings', 'All Sources', 'Emergent Questions'],
        questions: [
          {
            id: 1,
            question: 'What is the fundamental billing model for AI coding agents?',
            status: 'answered',
            answer: 'Token-based billing. Tokens (~4 characters) are the fundamental unit. Every API call consumes tokens. Unlike traditional software with near-zero marginal cost, every AI inference requires real compute. This is why agents shifted from unlimited subscriptions to metered pricing.',
            sources: [
              { title: 'Claude Code Smart Usage Guide v4', credibility: 'primary', url: '#' },
              { title: 'DX: AI Coding Assistant Pricing 2025', credibility: 'high', url: 'https://getdx.com/blog/ai-coding-assistant-pricing/' }
            ],
            emergent: ['How do caching mechanisms affect real-world costs?', 'What is the actual token count for typical agent workflows?']
          },
          {
            id: 2,
            question: 'Why do output tokens cost more than input tokens?',
            status: 'answered',
            answer: 'Output costs 2-5x more because generation is computationally harder. Processing input is a single forward pass. Generating each output token requires a full forward pass while maintaining attention over all previous tokens. Auto-regressive generation means a 1,000-token response requires 1,000 sequential forward passes.',
            sources: [
              { title: 'IBM: What is a Context Window?', credibility: 'high', url: 'https://www.ibm.com/think/topics/context-window' },
              { title: 'AIMultiple: LLM Pricing Comparison', credibility: 'high', url: 'https://research.aimultiple.com/llm-pricing/' }
            ],
            emergent: ['How does KV caching reduce this cost?', 'What\'s the compute ratio between input and output processing?']
          },
          {
            id: 3,
            question: 'How do AI coding agents differ economically from autocomplete tools?',
            status: 'answered',
            answer: 'Autocomplete: reactive, single suggestions, often flat-rate. Agents: autonomous multi-step execution, 5-20 model calls per task, metered pricing. The shift fundamentally changed economics because agents consume significantly more compute per task.',
            sources: [
              { title: 'GoCodeo: Autocomplete vs Autonomous', credibility: 'medium', url: 'https://www.gocodeo.com/post/autocomplete-vs-autonomous-the-spectrum-of-ai-coding-tools' }
            ],
            emergent: ['What\'s the crossover point where subscription becomes cheaper than usage-based?']
          },
          {
            id: 4,
            question: 'How does context window size affect costs?',
            status: 'researching',
            answer: 'Attention mechanism scales O(n¬≤) with context length. Longer contexts = quadratically more compute. This is why models charge more for larger context windows...',
            sources: [],
            emergent: ['Quantify the actual cost increase per context doubling']
          },
          {
            id: 5,
            question: 'What are effective strategies for managing AI coding costs?',
            status: 'pending',
            answer: null,
            sources: [],
            emergent: []
          }
        ],
        code: {
          file: 'cost_analysis.py',
          content: `<span class="cmt"># AI Coding Agent Cost Analysis</span>

PRICING <span class="op">=</span> {
    <span class="str">"claude-haiku"</span>:   {<span class="str">"input"</span>: <span class="num">0.25</span>,  <span class="str">"output"</span>: <span class="num">1.25</span>},
    <span class="str">"claude-sonnet-4"</span>: {<span class="str">"input"</span>: <span class="num">3.00</span>,  <span class="str">"output"</span>: <span class="num">15.00</span>},
    <span class="str">"claude-opus-4.5"</span>: {<span class="str">"input"</span>: <span class="num">15.00</span>, <span class="str">"output"</span>: <span class="num">75.00</span>},
}  <span class="cmt"># per million tokens</span>

<span class="kw">def</span> <span class="fn">calculate_cost</span>(
    input_tokens: <span class="type">int</span>,
    output_tokens: <span class="type">int</span>,
    model: <span class="type">str</span> <span class="op">=</span> <span class="str">"claude-sonnet-4"</span>
) <span class="op">-></span> <span class="type">float</span>:
    <span class="str">"""Calculate cost for a single API call."""</span>
    rates <span class="op">=</span> PRICING[model]
    <span class="kw">return</span> (
        input_tokens <span class="op">*</span> rates[<span class="str">"input"</span>] <span class="op">/</span> <span class="num">1_000_000</span> <span class="op">+</span>
        output_tokens <span class="op">*</span> rates[<span class="str">"output"</span>] <span class="op">/</span> <span class="num">1_000_000</span>
    )`,
          library: { name: 'tiktoken', url: 'https://github.com/openai/tiktoken', desc: 'Fast BPE tokenizer for counting tokens' }
        },
        canvas: {
          summary: { title: 'AI Coding Economics', content: '<ul><li>Every inference = real compute cost</li><li>Output costs 2-5x input</li><li>Agents = 5-20 calls per task</li><li>Context scales O(n¬≤)</li></ul>' },
          diagram: '<div style="text-align:center; padding: 20px; background: white; border-radius: 6px;"><pre style="font-family: monospace; font-size: 11px;">Cost Factors\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n‚Ä¢ Model choice\n‚Ä¢ Call count (5-20)\n‚Ä¢ Context size\n‚Ä¢ Output length\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nTypical task:\n~$0.15-0.25</pre></div>'
        }
      }
    };

    // ===================== RENDER FUNCTIONS =====================
    function setMode(mode) {
      const data = modeData[mode];
      document.documentElement.style.setProperty('--accent', data.accent);
      document.documentElement.style.setProperty('--accent-bg', data.accentBg);

      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });

      // Update chat placeholder based on mode
      const chatInput = document.getElementById('chat-input');
      if (mode === 'research') {
        chatInput.placeholder = 'Ask a question to add to research, or query existing findings...';
      } else if (mode === 'build') {
        chatInput.placeholder = 'Continue building...';
      } else {
        chatInput.placeholder = 'Ask a clarifying question...';
      }

      renderPathBar(data);
      renderTabs(data, mode);
      renderCodePanel(data);
      renderCanvasPanel(data);
    }

    function renderPathBar(data) {
      const pathBar = document.getElementById('path-bar');
      const nodesHtml = data.path.nodes.map((node, i) => {
        const isLast = i === data.path.nodes.length - 1;
        return `
          <div class="path-node ${isLast ? 'current' : ''}">
            <span class="node-dot ${node.status}"></span>
            ${node.name}
          </div>
          ${!isLast ? '<span class="path-arrow">‚Üí</span>' : ''}
        `;
      }).join('');

      const neighborsHtml = data.path.neighbors.map(n =>
        `<div class="neighbor-chip">${n}</div>`
      ).join('');

      pathBar.innerHTML = `
        <span class="path-label">Path</span>
        <div class="path-trail">${nodesHtml}</div>
        <div class="path-divider"></div>
        <span class="neighbors-label">Explore</span>
        <div class="neighbor-chips">${neighborsHtml}</div>
      `;
    }

    function renderTabs(data, mode) {
      const tabsEl = document.getElementById('content-tabs');
      const bodyEl = document.getElementById('content-body');

      tabsEl.innerHTML = data.tabs.map((tab, i) =>
        `<button class="content-tab ${i === 0 ? 'active' : ''}" onclick="showTab(${i})">${tab}</button>`
      ).join('');

      if (mode === 'build') {
        bodyEl.innerHTML = renderBuildPanels(data.panels);
      } else if (mode === 'understand') {
        bodyEl.innerHTML = renderUnderstandPanels(data.panels);
      } else if (mode === 'research') {
        bodyEl.innerHTML = renderResearchPanels(data);
      }
    }

    function renderBuildPanels(panels) {
      return `
        <div class="content-panel active" id="panel-0">
          <div class="narrative-header">
            <div class="narrative-label">${panels.narrative.label}</div>
            <h1 class="narrative-title">${panels.narrative.title}</h1>
            <div class="narrative-meta">${panels.narrative.meta}</div>
          </div>
          <div class="prose">${panels.narrative.content}</div>
        </div>
        <div class="content-panel" id="panel-1">
          <div class="narrative-header">
            <div class="narrative-label">Boundaries</div>
            <h1 class="narrative-title">Questions & Clarifications</h1>
          </div>
          <div class="qa-list">
            ${panels.boundaries.map(b => `
              <div class="qa-item">
                <div class="qa-question">${b.q}</div>
                <div class="qa-answer">${b.a}</div>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="content-panel" id="panel-2">
          <div class="narrative-header">
            <div class="narrative-label">Concepts</div>
            <h1 class="narrative-title">Vocabulary Built</h1>
          </div>
          <div class="concept-grid">
            ${panels.concepts.map(c => `
              <div class="concept-item">
                <div class="concept-term">${c.term}</div>
                <div class="concept-def">${c.def}</div>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="content-panel" id="panel-3">
          <div class="narrative-header">
            <div class="narrative-label">Self-Test</div>
            <h1 class="narrative-title">Questions I Can Now Answer</h1>
          </div>
          <div class="question-list">
            ${panels.questions.map(q => `<div class="question-item">${q}</div>`).join('')}
          </div>
        </div>
      `;
    }

    function renderUnderstandPanels(panels) {
      return `
        <div class="content-panel active" id="panel-0">
          <div class="narrative-header">
            <div class="narrative-label">${panels.narrative.label}</div>
            <h1 class="narrative-title">${panels.narrative.title}</h1>
            <div class="narrative-meta">${panels.narrative.meta}</div>
          </div>
          <div class="prose">${panels.narrative.content}</div>
        </div>
        <div class="content-panel" id="panel-1">
          <div class="narrative-header">
            <div class="narrative-label">Misconceptions</div>
            <h1 class="narrative-title">Common Confusions Clarified</h1>
          </div>
          <div class="qa-list">
            ${panels.misconceptions.map(m => `
              <div class="qa-item">
                <div class="qa-question">${m.q}</div>
                <div class="qa-answer">${m.a}</div>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="content-panel" id="panel-2">
          <div class="narrative-header">
            <div class="narrative-label">Insights</div>
            <h1 class="narrative-title">Key Realizations</h1>
          </div>
          <div class="concept-grid">
            ${panels.insights.map(i => `
              <div class="concept-item" style="border-left-color: #7C3AED; background: #F3E8FF;">
                <div class="concept-term" style="color: #5B21B6;">${i.insight}</div>
                <div class="concept-def">${i.context}</div>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="content-panel" id="panel-3">
          <div class="narrative-header">
            <div class="narrative-label">Synthesis</div>
            <h1 class="narrative-title">Mental Model</h1>
          </div>
          <div class="prose">${panels.mentalModel}</div>
        </div>
      `;
    }

    function renderResearchPanels(data) {
      const questions = data.questions;
      const answered = questions.filter(q => q.status === 'answered').length;
      const researching = questions.filter(q => q.status === 'researching').length;
      const pending = questions.filter(q => q.status === 'pending').length;

      const allFindings = questions
        .filter(q => q.answer)
        .map(q => ({ question: q.question, answer: q.answer }));

      const allSources = questions
        .flatMap(q => q.sources.map(s => ({ ...s, fromQuestion: q.question })))
        .filter((s, i, arr) => arr.findIndex(x => x.title === s.title) === i);

      const allEmergent = questions.flatMap(q => q.emergent);

      return `
        <div class="content-panel active" id="panel-0">
          <div class="narrative-header">
            <div class="narrative-label">Research</div>
            <h1 class="narrative-title">AI Coding Agent Economics</h1>
          </div>

          <div class="research-progress">
            <div class="progress-stat"><span class="dot answered"></span> ${answered} answered</div>
            <div class="progress-stat"><span class="dot researching"></span> ${researching} researching</div>
            <div class="progress-stat"><span class="dot pending"></span> ${pending} pending</div>
          </div>

          <div class="question-tree">
            ${questions.map(q => `
              <div class="research-question ${q.status} ${q.status === 'answered' ? 'expanded' : ''}" onclick="toggleQuestion(this)">
                <div class="rq-header">
                  <div class="rq-status ${q.status}">
                    ${q.status === 'answered' ? '‚úì' : q.status === 'researching' ? '‚óê' : '‚óã'}
                  </div>
                  <div class="rq-content">
                    <div class="rq-question">${q.question}</div>
                    <div class="rq-meta">${q.sources.length} sources ‚Ä¢ ${q.emergent.length} new questions emerged</div>
                  </div>
                </div>
                <div class="rq-body">
                  ${q.answer ? `
                    <div class="rq-answer">
                      <div class="rq-answer-label">Answer</div>
                      ${q.answer}
                    </div>
                  ` : ''}

                  ${q.sources.length > 0 ? `
                    <div class="rq-sources">
                      <div class="rq-sources-label">Sources</div>
                      ${q.sources.map(s => `
                        <div class="rq-source">
                          <a href="${s.url}" target="_blank">${s.title}</a>
                          <span class="rq-source-cred ${s.credibility}">${s.credibility}</span>
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}

                  ${q.emergent.length > 0 ? `
                    <div class="rq-emergent">
                      <div class="rq-emergent-label">New Questions Emerged</div>
                      ${q.emergent.map(e => `<div class="rq-emergent-item">${e}</div>`).join('')}
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('')}

            <div class="add-question-btn" onclick="promptAddQuestion()">
              + Add a question to research
            </div>
          </div>
        </div>

        <div class="content-panel" id="panel-1">
          <div class="narrative-header">
            <div class="narrative-label">Synthesis</div>
            <h1 class="narrative-title">All Findings</h1>
          </div>
          <div class="concept-grid">
            ${allFindings.map(f => `
              <div class="concept-item" style="border-left-color: #7C3AED;">
                <div class="concept-term" style="font-size: 14px;">${f.question}</div>
                <div class="concept-def">${f.answer}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="content-panel" id="panel-2">
          <div class="narrative-header">
            <div class="narrative-label">Evidence</div>
            <h1 class="narrative-title">All Sources</h1>
          </div>
          <div class="source-list" style="display: flex; flex-direction: column; gap: 10px;">
            ${allSources.map(s => `
              <div class="source-item ${s.credibility}" style="padding: 14px 18px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--accent);">
                <div class="source-title" style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">
                  <a href="${s.url}" target="_blank" style="color: inherit; text-decoration: none;">${s.title}</a>
                  <span class="source-cred ${s.credibility}" style="font-size: 10px; padding: 2px 6px; border-radius: 3px; font-weight: 600; text-transform: uppercase; margin-left: 8px;">${s.credibility}</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="content-panel" id="panel-3">
          <div class="narrative-header">
            <div class="narrative-label">Frontier</div>
            <h1 class="narrative-title">Emergent Questions</h1>
            <div class="narrative-meta">Questions that emerged during research ‚Äî candidates for further investigation</div>
          </div>
          <div class="question-list">
            ${allEmergent.map(q => `
              <div class="question-item" style="background: linear-gradient(135deg, #FEF2F2 0%, #FECACA 100%); border-left: 3px solid var(--gap);">${q}</div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderCodePanel(data) {
      const libraryHtml = data.code.library ? `
        <div class="library-ref">
          <div class="library-ref-label">Relevant Library</div>
          <a href="${data.code.library.url}" target="_blank">${data.code.library.name}</a> ‚Äî ${data.code.library.desc}
        </div>
      ` : '';

      document.getElementById('code-panel').innerHTML = `
        <div class="panel-header">
          <span class="panel-title">Code</span>
          <div class="panel-actions">
            <button class="panel-btn" title="Copy">üìã</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="code-file">üìÑ ${data.code.file}</div>
          <div class="code-block">${data.code.content}</div>
          ${libraryHtml}
        </div>
      `;
    }

    function renderCanvasPanel(data) {
      document.getElementById('canvas-panel').innerHTML = `
        <div class="panel-header">
          <span class="panel-title">Canvas</span>
          <div class="panel-actions">
            <button class="panel-btn" title="Export">‚Üó</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="canvas-tabs">
            <button class="canvas-tab active" onclick="showCanvas('summary')">Summary</button>
            <button class="canvas-tab" onclick="showCanvas('diagram')">Diagram</button>
          </div>
          <div class="canvas-content active" id="canvas-summary">
            <h4>${data.canvas.summary.title}</h4>
            ${data.canvas.summary.content}
          </div>
          <div class="canvas-content" id="canvas-diagram">
            ${data.canvas.diagram}
          </div>
        </div>
      `;
    }

    function showTab(index) {
      document.querySelectorAll('.content-tab').forEach((t, i) => t.classList.toggle('active', i === index));
      document.querySelectorAll('.content-panel').forEach((p, i) => p.classList.toggle('active', i === index));
    }

    function showCanvas(name) {
      document.querySelectorAll('.canvas-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.canvas-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('canvas-' + name).classList.add('active');
    }

    function toggleQuestion(el) {
      el.classList.toggle('expanded');
    }

    function promptAddQuestion() {
      const input = document.getElementById('chat-input');
      input.focus();
      input.placeholder = 'Type your research question...';
    }

    setMode('build');
  </script>
</body>
</html>
